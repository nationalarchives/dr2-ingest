name: DR2 Release Anonymiser Binary and docker image
on:
  push:
    branches:
      - main
permissions:
  id-token: write
  contents: write
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
      - id: next-tag
        uses: nationalarchives/dr2-github-actions/.github/actions/get-next-version@917201e254f112ff041b952dae76ef767cae7378
        with:
          repo-name: dr2-court-document-package-anonymiser
      - run: |
          cargo build --release -p anonymiser
          git tag ${{ steps.next-tag.outputs.next-version }}
          git push origin ${{ steps.next-tag.outputs.next-version }}
          gh release create ${{ steps.next-tag.outputs.next-version }} target/release/anonymiser
        env:
          GITHUB_TOKEN: ${{ secrets.WORKFLOW_TOKEN }}
  docker-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
      - name: Configure AWS credentials for ECR
        uses: aws-actions/configure-aws-credentials@d4695650384537945e0b565ee73a714d361bcb04
        with:
          role-to-assume: arn:aws:iam::${{ secrets.MANAGEMENT_ACCOUNT_NUMBER }}:role/MgmtDPGithubImageDeploy
          aws-region: us-east-1
          role-session-name: ECRLogin
      - uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef
        with:
          registry: public.ecr.aws
      - run: |
          sudo apt-get install musl-tools
          rustup target add x86_64-unknown-linux-musl
          cargo build --release --target x86_64-unknown-linux-musl
          docker build -t public.ecr.aws/u4s1g5v1/anonymiser .
          docker push public.ecr.aws/u4s1g5v1/anonymiser
  documentation-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
        with:
          fetch-depth: '0'
      - run:  |
          cargo doc --no-deps --workspace --document-private-items
          git config --global user.email 181243999+tna-da-bot@users.noreply.github.com 
          git config --global user.name tna-da-bot
          git checkout gh-pages
          rm -rf docs
          mv target/doc/ docs
          git add docs
          git commit -m "Update site documentation"
          git push -u origin gh-pages
  deploy-lambda:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
      - run: gh workflow run deploy_lambda.yml
        env:
          GITHUB_TOKEN: ${{ secrets.WORKFLOW_TOKEN }}
